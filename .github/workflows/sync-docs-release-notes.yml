name: Sync Release Notes to Docs

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to sync (e.g., v1.0.0)'
        required: true

jobs:
  sync-release-notes:
    runs-on: ubuntu-latest
    steps:
      - name: Get release info
        id: release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="${{ github.event.release.tag_name }}"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT

          # Get release body and published date
          RELEASE_JSON=$(gh release view "$TAG" --repo ${{ github.repository }} --json body,publishedAt)
          BODY=$(echo "$RELEASE_JSON" | jq -r '.body')
          PUBLISHED_AT=$(echo "$RELEASE_JSON" | jq -r '.publishedAt')
          RELEASE_DATE=$(date -d "$PUBLISHED_AT" +"%Y-%m-%d" 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$PUBLISHED_AT" +"%Y-%m-%d" 2>/dev/null || echo "$PUBLISHED_AT")

          echo "date=$RELEASE_DATE" >> $GITHUB_OUTPUT
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Checkout hyperstudy-docs
        uses: actions/checkout@v4
        with:
          repository: ljchang/hyperstudy-docs
          token: ${{ secrets.DOCS_REPO_TOKEN }}
          path: docs-repo

      - name: Check if release already exists
        id: check
        run: |
          TAG="${{ steps.release.outputs.tag }}"
          FILE="docs-repo/docs/devices/hyperstudy-gige.md"

          if grep -q "### $TAG" "$FILE" 2>/dev/null; then
            echo "Release $TAG already exists in docs"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "Release $TAG not found in docs, will add"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Update release notes
        if: steps.check.outputs.exists == 'false'
        run: |
          TAG="${{ steps.release.outputs.tag }}"
          DATE="${{ steps.release.outputs.date }}"
          FILE="docs-repo/docs/devices/hyperstudy-gige.md"

          # Create the new release entry
          RELEASE_ENTRY="### $TAG

**Released:** $DATE

${{ steps.release.outputs.body }}

---"

          # Insert after RELEASE_NOTES_START marker
          # Use awk to insert content after the marker line
          awk -v entry="$RELEASE_ENTRY" '
            /<!-- RELEASE_NOTES_START -->/ {
              print
              print ""
              print entry
              next
            }
            { print }
          ' "$FILE" > "$FILE.tmp" && mv "$FILE.tmp" "$FILE"

          echo "Updated $FILE with release $TAG"

      - name: Commit and push
        if: steps.check.outputs.exists == 'false'
        run: |
          cd docs-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/devices/hyperstudy-gige.md
          git commit -m "Update GigE Virtual Camera release notes for ${{ steps.release.outputs.tag }}" || exit 0
          git push

