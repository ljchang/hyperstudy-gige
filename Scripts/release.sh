#!/bin/bash

# release.sh - Complete release process for GigE Virtual Camera
# This script handles: build -> sign -> notarize -> create DMG -> notarize DMG

set -e

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
OUTPUT_DIR="$PROJECT_ROOT/build/distribution"
RELEASE_DIR="$PROJECT_ROOT/build/Release"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m'

print_status() {
    echo -e "${BLUE}==>${NC} $1"
}

print_success() {
    echo -e "${GREEN}âœ…${NC} $1"
}

print_error() {
    echo -e "${RED}âŒ${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸${NC} $1"
}

# Check if we're in the right directory
if [ ! -f "$PROJECT_ROOT/CLAUDE.md" ]; then
    print_error "Please run this script from the project root"
    exit 1
fi

echo ""
echo "ðŸš€ GigE Virtual Camera Release Process"
echo "======================================"
echo ""

# Step 1: Build release version
print_status "Step 1: Building release version..."
cd "$PROJECT_ROOT"
"$SCRIPT_DIR/build_release.sh"

# Find the built app
BUILT_APP=$(find "$RELEASE_DIR" -name "GigEVirtualCamera.app" -type d | head -1)
if [ ! -d "$BUILT_APP" ]; then
    print_error "Release app not found in $RELEASE_DIR"
    exit 1
fi

print_success "Release app built: $BUILT_APP"

# Step 2: Notarize the app
print_status "Step 2: Notarizing the app..."
"$SCRIPT_DIR/notarize.sh" "$BUILT_APP"

# Check if notarization succeeded
if ! xcrun stapler validate "$BUILT_APP" 2>&1 | grep -q "The validate action worked"; then
    print_error "App notarization failed"
    exit 1
fi

print_success "App notarization completed"

# Step 3: Create DMG
print_status "Step 3: Creating DMG..."
"$SCRIPT_DIR/create_dmg.sh" "$BUILT_APP"

# Find the created DMG
DMG_FILE="$OUTPUT_DIR/GigEVirtualCamera.dmg"
if [ ! -f "$DMG_FILE" ]; then
    print_error "DMG not found at $DMG_FILE"
    exit 1
fi

# Step 4: Notarize the DMG
print_status "Step 4: Notarizing the DMG..."
"$SCRIPT_DIR/notarize.sh" "$DMG_FILE"

# Check if DMG notarization succeeded
if ! xcrun stapler validate "$DMG_FILE" 2>&1 | grep -q "The validate action worked"; then
    print_error "DMG notarization failed"
    exit 1
fi

print_success "DMG notarization completed"

# Step 5: Final verification
print_status "Step 5: Final verification..."

# Check app
print_status "Verifying app..."
if spctl -a -vvv "$BUILT_APP" 2>&1 | grep -q "source=Notarized Developer ID"; then
    print_success "App verification passed"
else
    print_warning "App verification shows issues"
fi

# Check DMG
print_status "Verifying DMG..."
if spctl -a -vvv "$DMG_FILE" 2>&1 | grep -q "source=Notarized Developer ID"; then
    print_success "DMG verification passed"
else
    print_warning "DMG verification shows issues"
fi

# Step 6: Create release summary
print_status "Step 6: Creating release summary..."

# Get app version
APP_VERSION=$(defaults read "$BUILT_APP/Contents/Info.plist" CFBundleShortVersionString 2>/dev/null || echo "Unknown")
BUILD_NUMBER=$(defaults read "$BUILT_APP/Contents/Info.plist" CFBundleVersion 2>/dev/null || echo "Unknown")

# Get file sizes
APP_SIZE=$(du -h "$BUILT_APP" | tail -1 | cut -f1)
DMG_SIZE=$(du -h "$DMG_FILE" | cut -f1)

# Create release info
RELEASE_INFO="$OUTPUT_DIR/release-info.txt"
cat > "$RELEASE_INFO" << EOF
GigE Virtual Camera Release Summary
==================================

Version: $APP_VERSION ($BUILD_NUMBER)
Build Date: $(date)

Files Created:
- App: $BUILT_APP ($APP_SIZE)
- DMG: $DMG_FILE ($DMG_SIZE)

Verification Status:
- App signed: âœ…
- App notarized: âœ…
- DMG signed: âœ…
- DMG notarized: âœ…

Release Notes:
- Creates virtual camera from GigE Vision cameras
- Supports macOS 10.15+ 
- Includes built-in test camera for development
- Camera Extension for system-wide virtual camera access

Installation:
1. Download and mount the DMG
2. Drag GigEVirtualCamera.app to Applications
3. Launch the app and grant permissions
4. Virtual camera will appear in Photo Booth, QuickTime, etc.

Technical Details:
- Code signing: Developer ID Application
- Notarization: Apple Developer Program
- Architecture: Universal Binary (x86_64 + arm64)
- System Extension: Camera Extension API

Distribution:
- DMG is ready for public distribution
- No Gatekeeper warnings on user systems
- Automatic updates via built-in updater (if implemented)

Support:
- Documentation: See README.md
- Issues: GitHub Issues
- Contact: Developer support

Generated by: $0
EOF

echo ""
print_success "ðŸŽ‰ Release process complete!"
echo ""
echo "ðŸ“¦ Release Files:"
echo "   App: $BUILT_APP"
echo "   DMG: $DMG_FILE"
echo "   Info: $RELEASE_INFO"
echo ""
echo "ðŸ“Š Summary:"
echo "   Version: $APP_VERSION ($BUILD_NUMBER)"
echo "   App Size: $APP_SIZE"
echo "   DMG Size: $DMG_SIZE"
echo ""
echo "âœ… All files are signed and notarized"
echo "âœ… Ready for distribution"
echo ""
echo "Next steps:"
echo "1. Test the DMG on a clean Mac"
echo "2. Upload to your distribution platform"
echo "3. Update release notes and documentation"
echo "4. Announce the release"
echo ""

# Show the release directory
print_status "Opening release directory..."
open "$OUTPUT_DIR"

print_success "Release process completed successfully! ðŸŽ‰"