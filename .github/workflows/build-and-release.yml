name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-14  # Apple Silicon runner

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set version from tag
        id: version
        run: |
          if [ "${{ github.event.inputs.version }}" != "" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/}
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Install dependencies
        run: |
          echo "Installing Homebrew dependencies..."
          brew update
          brew install aravis

          # Verify Aravis installation
          brew list aravis
          pkg-config --modversion aravis-0.8

      - name: Import code signing certificate
        env:
          CERTIFICATE_BASE64: ${{ secrets.MACOS_CERTIFICATE_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD || 'temp-keychain-pass' }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/build.keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import certificate
          echo "$CERTIFICATE_BASE64" | base64 --decode > $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 \
            -k $KEYCHAIN_PATH \
            -P "$CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/productsign

          # Set key partition list
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Add keychain to search list
          security list-keychains -d user -s $KEYCHAIN_PATH $(security list-keychains -d user | sed s/\"//g)

          # Verify certificate
          security find-identity -v -p codesigning $KEYCHAIN_PATH

          echo "Certificate imported successfully"

      - name: Install provisioning profiles
        env:
          PROFILE_APP_BASE64: ${{ secrets.MACOS_PROVISIONING_PROFILE_APP_BASE64 }}
          PROFILE_EXT_BASE64: ${{ secrets.MACOS_PROVISIONING_PROFILE_EXT_BASE64 }}
        run: |
          PP_PATH=~/Library/MobileDevice/Provisioning\ Profiles
          mkdir -p "$PP_PATH"

          # Install app provisioning profile
          echo "$PROFILE_APP_BASE64" | base64 --decode > "$PP_PATH/gige_app.provisionprofile"

          # Install extension provisioning profile
          echo "$PROFILE_EXT_BASE64" | base64 --decode > "$PP_PATH/gige_ext.provisionprofile"

          echo "Provisioning profiles installed"
          ls -la "$PP_PATH"

      - name: Build application
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          CODE_SIGN_IDENTITY: "Developer ID Application"
        run: |
          echo "Building GigE Virtual Camera..."

          # Get Aravis paths dynamically using symlinked paths
          ARAVIS_PREFIX="/opt/homebrew/opt/aravis"
          GLIB_PREFIX="/opt/homebrew/opt/glib"
          GETTEXT_PREFIX="/opt/homebrew/opt/gettext"
          PCRE2_PREFIX="/opt/homebrew/opt/pcre2"

          echo "Using Aravis from: $ARAVIS_PREFIX"

          # Build with dynamic header paths
          xcodebuild -project GigEVirtualCamera.xcodeproj \
            -scheme GigEVirtualCamera \
            -configuration Release \
            -derivedDataPath build/DerivedData \
            -destination "generic/platform=macOS" \
            DEVELOPMENT_TEAM="$APPLE_TEAM_ID" \
            CODE_SIGN_STYLE="Manual" \
            CODE_SIGN_IDENTITY="Developer ID Application" \
            HEADER_SEARCH_PATHS="/opt/homebrew/include ${ARAVIS_PREFIX}/include/aravis-0.8 ${GLIB_PREFIX}/include ${GLIB_PREFIX}/include/glib-2.0 ${GLIB_PREFIX}/lib/glib-2.0/include ${GETTEXT_PREFIX}/include ${PCRE2_PREFIX}/include /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/include/ffi" \
            LIBRARY_SEARCH_PATHS="/opt/homebrew/lib ${ARAVIS_PREFIX}/lib" \
            clean build

          echo "Build completed successfully"

      - name: Embed provisioning profiles and re-sign
        env:
          CODE_SIGN_IDENTITY: "Developer ID Application"
        run: |
          APP_PATH="build/DerivedData/Build/Products/Release/GigEVirtualCamera.app"
          PROFILES_DIR="$HOME/Library/MobileDevice/Provisioning Profiles"

          echo "Step 1: Embedding provisioning profiles..."

          # Embed app provisioning profile
          echo "Looking for app provisioning profile..."
          for profile in "$PROFILES_DIR"/*.provisionprofile; do
            if [ -f "$profile" ]; then
              # Check if this is the app profile (not extension)
              if security cms -D -i "$profile" 2>/dev/null | grep -q "com.lukechang.GigEVirtualCamera" && \
                 ! security cms -D -i "$profile" 2>/dev/null | grep -q "com.lukechang.GigEVirtualCamera.Extension"; then
                cp "$profile" "$APP_PATH/Contents/embedded.provisionprofile"
                echo "✅ Embedded app provisioning profile"
                break
              fi
            fi
          done

          # Verify app profile was embedded
          if [ ! -f "$APP_PATH/Contents/embedded.provisionprofile" ]; then
            echo "❌ ERROR: App provisioning profile not found!"
            exit 1
          fi

          # Embed extension provisioning profile
          EXTENSION_PATH="$APP_PATH/Contents/Library/SystemExtensions"
          EXT_FULL_PATH="$EXTENSION_PATH/com.lukechang.GigEVirtualCamera.Extension.systemextension"

          echo "Looking for extension provisioning profile..."
          EXT_PROFILE=""
          for profile in "$PROFILES_DIR"/*.provisionprofile; do
            if [ -f "$profile" ]; then
              # Check if this is the extension profile
              if security cms -D -i "$profile" 2>/dev/null | grep -q "com.lukechang.GigEVirtualCamera.Extension"; then
                EXT_PROFILE="$profile"
                break
              fi
            fi
          done

          if [ -n "$EXT_PROFILE" ]; then
            cp "$EXT_PROFILE" "$EXT_FULL_PATH/Contents/embedded.provisionprofile"
            echo "✅ Embedded extension provisioning profile"
          else
            echo "❌ ERROR: Extension provisioning profile not found in $PROFILES_DIR!"
            exit 1
          fi

          echo "Step 2: Cleaning hidden files..."
          find "$APP_PATH" -name ".DS_Store" -delete 2>/dev/null || true
          find "$APP_PATH" -name "._*" -delete 2>/dev/null || true

          echo "Step 3: Signing bundled libraries..."
          if [ -d "$APP_PATH/Contents/Frameworks" ]; then
            find "$APP_PATH/Contents/Frameworks" -name "*.dylib" -type f | while read lib; do
              echo "Signing: $(basename "$lib")"
              codesign --force --sign "$CODE_SIGN_IDENTITY" --timestamp --options runtime "$lib"
            done
          fi

          echo "Step 4: Re-signing extension..."
          # Remove old signature first
          codesign --remove-signature "$EXT_FULL_PATH" 2>/dev/null || true

          # Re-sign with entitlements
          codesign --force --sign "$CODE_SIGN_IDENTITY" \
            --entitlements GigEVirtualCameraExtension/GigEVirtualCameraExtension-Distribution.entitlements \
            --timestamp \
            --options runtime \
            "$EXT_FULL_PATH"
          echo "✅ Extension signed"

          echo "Step 5: Re-signing main app..."
          # Remove old signature first
          codesign --remove-signature "$APP_PATH" 2>/dev/null || true

          # Re-sign WITHOUT --deep flag (important!)
          codesign --force --sign "$CODE_SIGN_IDENTITY" \
            --entitlements GigECameraApp/GigECamera-Distribution.entitlements \
            --timestamp \
            --options runtime \
            "$APP_PATH"
          echo "✅ App signed"

          echo "Signing completed"

      - name: Verify code signing
        run: |
          APP_PATH="build/DerivedData/Build/Products/Release/GigEVirtualCamera.app"
          EXTENSION_PATH="$APP_PATH/Contents/Library/SystemExtensions/com.lukechang.GigEVirtualCamera.Extension.systemextension"

          echo "Verifying extension signature..."
          if codesign --verify --verbose --strict "$EXTENSION_PATH" 2>&1; then
            echo "✅ Extension signature valid"
          else
            echo "❌ Extension signature invalid"
            exit 1
          fi

          echo "Verifying app signature (deep check)..."
          if codesign --verify --deep --strict "$APP_PATH" 2>&1; then
            echo "✅ App signature valid"
          else
            echo "❌ App signature invalid"
            exit 1
          fi

          echo "Checking provisioning profiles..."
          if [ -f "$APP_PATH/Contents/embedded.provisionprofile" ]; then
            echo "✅ App has embedded provisioning profile"
          else
            echo "❌ App missing embedded provisioning profile"
            exit 1
          fi

          if [ -f "$EXTENSION_PATH/Contents/embedded.provisionprofile" ]; then
            echo "✅ Extension has embedded provisioning profile"
          else
            echo "❌ Extension missing embedded provisioning profile"
            exit 1
          fi

          echo "Checking signing identity..."
          codesign -dvvv "$APP_PATH"

          echo "✅ Code signing verification completed"

      - name: Notarize application
        env:
          NOTARIZATION_APPLE_ID: ${{ secrets.NOTARIZATION_APPLE_ID }}
          NOTARIZATION_PASSWORD: ${{ secrets.NOTARIZATION_PASSWORD }}
          NOTARIZATION_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          APP_PATH="build/DerivedData/Build/Products/Release/GigEVirtualCamera.app"

          echo "Creating ZIP for notarization..."
          ditto -c -k --keepParent "$APP_PATH" "$RUNNER_TEMP/GigEVirtualCamera.zip"

          echo "Submitting for notarization..."
          xcrun notarytool submit "$RUNNER_TEMP/GigEVirtualCamera.zip" \
            --apple-id "$NOTARIZATION_APPLE_ID" \
            --password "$NOTARIZATION_PASSWORD" \
            --team-id "$NOTARIZATION_TEAM_ID" \
            --wait \
            --timeout 30m

          echo "Stapling notarization ticket..."
          xcrun stapler staple "$APP_PATH"

          echo "Verifying notarization..."
          xcrun stapler validate "$APP_PATH"
          spctl -a -vv "$APP_PATH"

          echo "Notarization completed successfully"

      - name: Create DMG
        env:
          CODE_SIGN_IDENTITY: "Developer ID Application"
        run: |
          APP_PATH="build/DerivedData/Build/Products/Release/GigEVirtualCamera.app"
          OUTPUT_DIR="build/distribution"
          mkdir -p "$OUTPUT_DIR"

          echo "Creating DMG..."
          ./Scripts/create_dmg.sh "$APP_PATH"

          # Rename DMG with version
          VERSION="${{ steps.version.outputs.VERSION }}"
          mv "$OUTPUT_DIR/GigEVirtualCamera.dmg" "$OUTPUT_DIR/GigEVirtualCamera-${VERSION}.dmg"

          echo "DMG created: $OUTPUT_DIR/GigEVirtualCamera-${VERSION}.dmg"

      - name: Notarize DMG
        env:
          NOTARIZATION_APPLE_ID: ${{ secrets.NOTARIZATION_APPLE_ID }}
          NOTARIZATION_PASSWORD: ${{ secrets.NOTARIZATION_PASSWORD }}
          NOTARIZATION_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          DMG_PATH="build/distribution/GigEVirtualCamera-${VERSION}.dmg"

          echo "Submitting DMG for notarization..."
          xcrun notarytool submit "$DMG_PATH" \
            --apple-id "$NOTARIZATION_APPLE_ID" \
            --password "$NOTARIZATION_PASSWORD" \
            --team-id "$NOTARIZATION_TEAM_ID" \
            --wait \
            --timeout 20m

          echo "Stapling notarization ticket to DMG..."
          xcrun stapler staple "$DMG_PATH"

          echo "Verifying DMG notarization..."
          xcrun stapler validate "$DMG_PATH"

          echo "DMG notarization completed successfully"

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"

          cat > $RUNNER_TEMP/release_notes.md << EOF
          # GigE Virtual Camera ${VERSION}

          macOS application for creating virtual cameras from GigE Vision cameras.

          ## Installation

          1. Download the DMG file below
          2. Open the DMG and drag GigEVirtualCamera.app to Applications
          3. Launch the application
          4. Grant system extension permission in System Settings → Privacy & Security
          5. Connect to your GigE camera

          ## Requirements

          - macOS 12.3 or later
          - Apple Silicon Mac (arm64)
          - GigE Vision camera (or use built-in test camera)

          ## What's New

          See CHANGELOG.md for detailed changes.

          ## Support

          For issues and feature requests, please visit the GitHub Issues page.
          EOF

          echo "Release notes generated"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: build/distribution/GigEVirtualCamera-${{ steps.version.outputs.VERSION }}.dmg
          body_path: ${{ runner.temp }}/release_notes.md
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup keychain
        if: always()
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/build.keychain
          if [ -f "$KEYCHAIN_PATH" ]; then
            security delete-keychain $KEYCHAIN_PATH
          fi
          rm -f $RUNNER_TEMP/certificate.p12
          echo "Cleanup completed"
